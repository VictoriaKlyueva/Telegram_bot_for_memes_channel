import telebot
import os
import onnxruntime as ort
import numpy as np
from PIL import Image

CHANNEL_ID = -1002242343472


def import_token(path):
    with open(os.path.join(path, 'token.txt')) as f:
        token = f.read().strip()

    return token


# Making bot session
token = import_token('')
bot = telebot.TeleBot(token)

# Making ort session for GAN
ort_session_gan = ort.InferenceSession('generator.onnx')


# Get image, generated by GAN
def generate_image():
    random_noise = np.random.randn(1, 100, 1, 1).astype(np.float32)
    # Get model output
    generated_image = ort_session_gan.run(None, {'input_noise': random_noise})
    generated_image = np.array(generated_image[0][0])

    # Swap array dimensions
    generated_image = generated_image.transpose((1, 2, 0))
    # Scale the image pixels back to (0, 255)
    generated_image = (generated_image + 1) * 127.5
    # Convert to uint8 for PIL conversion
    generated_image = generated_image.astype(np.uint8)

    pil_image = Image.fromarray(generated_image)

    # Creating folder for generated images and text
    if not os.path.isdir("generated_data"):
        os.mkdir("generated_data")

    # Save the PIL image in the root folder
    pil_image.save('generated_data/generated_image.png')


@bot.message_handler(content_types=['text', 'image'])
def send_meme(message):
    generate_image()
    file = open('generated_data/generated_image.png', 'rb')
    bot.send_photo(CHANNEL_ID, file)


# Loop for code execution
bot.infinity_polling(timeout=10, long_polling_timeout=5)
